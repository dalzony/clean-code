# 13. 동시성

## [동시성 이란?]
- 결합을 없애고 '무엇'과 '언제'를 분리하는 전략
- 멀티스레드 프로그래밍

## [동시성이 필요한 이유]
- 처리 성능 한계로 인해 동시성 구현이 불가피
- 분리가 쉬워지는 구조적 장점

## [동시성의 잘못된 생각]
- 동시성은 항상 성능을 높여준다? (X)
<br> --> 
<br>(대기 시간이 아주 길어 여러 스레드가 프로세서를 공유할 수 있거나, 
<br>여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우에만 성능이 높아진다)

- 동시성을 구현해도 설계는 변하지 않는다? (X)
<br> --> 설계가 달라져야 하고 시스템 구조가 달라진다.

- 웹이나 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다? (X)
<br> --> 컨테이너 동작 원리를 이해해야 동시 수정, 데드락 같은 문제를 피할 수 있다.

## [동시성의 타당한 생각]
- 성능 부하를 유발한다.
- 복잡하다.
- 재현하기 어렵다. (일회성 문제로 간주된다. 타이밍 이슈)
- 전략적인 설계가 필요하다.

## [동시성 문제 발생의 예]
```java
public class X {
  private int lastIdUsed;
  public int getNextId(){
    return ++lastIdUsed;
  }
}
```
메소드 getNextId를 여러 스레드로 동시에 실행할 경우 
<br>lastIdUsed 변수를 공유하고 있기 때문에 의도하지 않은 계산 결과가 나올 수 있다.

## [동시성 방어 원칙]

### 단일 책임 원칙 (Single Responsiblity Principle)
SRP: 주어진 메소드/클래스/컨포너트르 변경할 이유가 하나여야 한다는 원칙
<br>동시성 코드는 복잡하다. 다른 코드와 분리하라.

* __데이터 범위를 제한__
<br>데이터 공유를 보호할 구간에 임계 영역 처리 (critical section / synchronized)
<br>임계영역의 개수가 적을 수록, 구간의 길이가 적을 수록 좋다. (밑에서 또 얘기함)

* __데이터 복사하여 사용__
<br>각 스레드가 복사한 데이터를 변경한 후 결과를 받아 처리하는 방식.

* __스레드는 가능한 독립적으로 구현__
<br>공유 데이터를 사용하지 않도록 구현한다.

### 라이브러리를 이해하라
* __스레드환경에 안전한 집합 컬렉션__
<br>HashMap 대신 멀티 스레드에 안전하도록 설계된 ConcurrentHashMap을 사용한다.
<br>java.util.concurrent / java.util.concurrent.atomic / java.util.conrueent.locks 참조

### 실행 모델을 이해하라
* __생산자-소비자 모델__
<br>생산자 스레드가 데이터를 버퍼나 큐에 넣고 소비사 스레드가 큐에 있는 데이터를 가져와 사용하는 모델
<br>생산자는 '큐에 빈공간이 있다'는 신호를 받아야 데이터를 보내고
<br>소비자는 '큐에 데이터가 있다'는 신호를 받아야 데이터를 가져온다.
<br>멀티스레드로 동작시 신호 전달 충돌로 서로 신호를 기다리는 상황이 발생할 수 있다.

* __읽기-쓰기 모델__

* __식사하는 철학자들 모델__
<br>둥근 식탁에 철학자들이 앉아 있고 철학자 왼쪽에 포크가 있는 구조. 양손에 포크를 들어야 밥을 먹을 수 있다.
<br>철학자-스레드 / 포크-자원
<br>제대로 구현하지 않으면 데드락, 라이브락, 처리율 저하. 효율성 저하가 발생할 수 있다.

### 동기화하는 메소드 사이에 의존성을 이해하라
* 공유 개체 하나에는 메소드 하나만 사용한다.
* 여러 메소드를 사용해야하는 경우 메소드 처리 전에 서버를 잠근다.
<br>클라이언트 잠금 / 서버 잠금 / 어랩터 서버 사용(중간에 잠금 기능을 제공하는 서버) - 자세한 내용 책 참조

### 동기화하는 부분을 작게 만들어라
* Synchronized 키워드로 설정한 코드 영역은 한번에 스레드 하나만 실행 가능하다.
<br>--> 스레드 지연 및 부하의 원인이 됨.
<br>--> 여러군데나 큰 영역에 사용하는 것은 성능에 좋지 않으므로 필요한 부분만 최소화하여 사용한다.

### 올바른 종료 코드를 구현하라

## [스레드 코드 테스트]
테스트 코드를 작성하고 프로그램 구성과 부하 등 환경을 바꿔가며 여려번 수행한다.

### 테스트 접근 방법
* __말이 안되는 실패는 잠정적인 스레드 문제로 취급.__
<br>일회성 실패일 떄도 원인을 추적하라. (특정 환경에서 다시 발생한다)

* __순차 코드부터 확인.__
<br>먼저 스레드 환경 밖에서 잘 동작하는지 확인한다.

* __다양한 구성의 스레드 코드 구현.__
<br>스레드 수 변경.
<br>속도 변경.
<br>반복 테스트 가능하도록 작성.

* __프로세스 수 보다 많은 스레드로 실행.__
<br>스레드 스와핑 시 발생하는 문제를 찾을 수 있다.

* __다양한 플랫폼에서 테스트.__
<br>OS 버전 등.

* __보조 코드를 넣거나 강제로 실패를 일으켜 테스트.__
<br>직접 구현 - wait(), sleep(), yield(), priority()
<br>자동화 - AOF(Aspect-Oriented Framework), CGLIB, ASM 등의 도구 사용
<br>ThreadJigglePoint.jiggle() - 흔들기 기법. 무작위로 sleep이나 yield 등을 호출.
